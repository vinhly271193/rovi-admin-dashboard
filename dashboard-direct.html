<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROVI Admin Dashboard - Direct Auth</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        .auth-code-section {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .auth-code {
            font-family: monospace;
            background: white;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            word-break: break-all;
        }
        .manual-auth {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>üèÉ ROVI Admin Dashboard</h1>
            <p>Direct Authentication Version</p>
            
            <!-- Method 1: Sign in with redirect workaround -->
            <div style="margin-top: 2rem;">
                <h3>Method 1: Google Sign-In</h3>
                <button id="googleSignInBtn" class="btn-primary" style="width: 100%;">
                    Sign in with Google
                </button>
                <div id="authError" style="color: red; margin-top: 0.5rem;"></div>
            </div>

            <!-- Method 2: Manual token entry -->
            <div class="manual-auth">
                <h3>Method 2: Direct Access with Admin UID</h3>
                <p style="font-size: 0.875rem; color: #718096;">
                    If Google Sign-In fails, use this direct access method:
                </p>
                <button id="directAccessBtn" class="btn-primary" style="width: 100%; background: #48bb78;">
                    Access as Admin (byothLpU8SdS5SYpx1UFT0pGT0p1)
                </button>
            </div>

            <div id="loginStatus" style="margin-top: 1rem; padding: 1rem; display: none;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard-container" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ROVI Admin</h2>
                <span id="userInfo" style="font-size: 0.75rem; color: #718096;"></span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="overview">
                    <span class="icon">üìä</span> Overview
                </li>
                <li class="nav-item" data-page="users">
                    <span class="icon">üë•</span> Users
                </li>
                <li class="nav-item" data-page="activity">
                    <span class="icon">üèÉ</span> Activity
                </li>
                <li class="nav-item" data-page="nutrition">
                    <span class="icon">üçé</span> Nutrition
                </li>
            </ul>
            <div class="sidebar-footer">
                <button id="refreshBtn" class="btn-refresh">üîÑ Refresh</button>
                <button id="exitBtn" class="btn-logout">Exit Dashboard</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <h1>Dashboard Overview</h1>
                <span id="connectionStatus" style="font-size: 0.875rem;"></span>
            </header>

            <div class="page-content">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3>Total Users</h3>
                            <p class="stat-value" id="totalUsers">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÉ</div>
                        <div class="stat-content">
                            <h3>Active Today</h3>
                            <p class="stat-value" id="activeToday">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-content">
                            <h3>Total Steps Today</h3>
                            <p class="stat-value" id="totalSteps">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üçé</div>
                        <div class="stat-content">
                            <h3>Foods Logged</h3>
                            <p class="stat-value" id="foodsLogged">-</p>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="chart-card" style="margin-top: 2rem;">
                    <h3>User Details</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Email</th>
                                    <th>Steps Today</th>
                                    <th>Activities</th>
                                    <th>Foods</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr><td colspan="5">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Debug Info -->
                <div class="chart-card" style="margin-top: 2rem; background: #f7fafc;">
                    <h3>Connection Info</h3>
                    <div id="debugInfo" style="font-family: monospace; font-size: 0.875rem;">
                        Waiting for authentication...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrNsSCG2FJ1es4BHe_URbwhuEpkA_5VyU",
            authDomain: "rovi-16b3a.firebaseapp.com",
            projectId: "rovi-16b3a",
            storageBucket: "rovi-16b3a.firebasestorage.app",
            databaseURL: "https://rovi-16b3a-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ADMIN_UID = 'byothLpU8SdS5SYpx1UFT0pGT0p1';
        let currentUser = null;

        // Method 1: Try Google Sign-In with signInWithRedirect
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            const btn = document.getElementById('googleSignInBtn');
            const status = document.getElementById('loginStatus');
            const error = document.getElementById('authError');
            
            btn.disabled = true;
            btn.textContent = 'Attempting sign in...';
            error.textContent = '';
            status.style.display = 'block';
            status.innerHTML = 'Redirecting to Google...';
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                // Try redirect method instead of popup
                await auth.signInWithRedirect(provider);
            } catch (err) {
                console.error('Sign in error:', err);
                error.textContent = `Error: ${err.message}`;
                btn.disabled = false;
                btn.textContent = 'Sign in with Google';
                status.style.display = 'none';
                
                // If it fails, show alternative
                if (err.code === 'auth/operation-not-allowed' || err.code === 'auth/unauthorized-domain') {
                    error.innerHTML = `
                        <strong>Domain not authorized.</strong><br>
                        Please use "Direct Access" button below or add localhost to Firebase authorized domains.
                    `;
                }
            }
        });

        // Check for redirect result on page load
        auth.getRedirectResult().then((result) => {
            if (result.credential) {
                console.log('Redirect sign-in successful');
                handleAuthSuccess(result.user);
            }
        }).catch((error) => {
            console.error('Redirect result error:', error);
        });

        // Method 2: Direct admin access (bypass Google sign-in)
        document.getElementById('directAccessBtn').addEventListener('click', async () => {
            const btn = document.getElementById('directAccessBtn');
            const status = document.getElementById('loginStatus');
            
            btn.disabled = true;
            btn.textContent = 'Accessing dashboard...';
            status.style.display = 'block';
            status.innerHTML = '<strong>Direct Admin Access Mode</strong><br>Bypassing authentication...';
            
            // Simulate admin access without actual authentication
            // This works because your Firestore rules check for the specific UID
            currentUser = {
                uid: ADMIN_UID,
                email: 'vinh2711@googlemail.com',
                displayName: 'Admin (Direct Access)'
            };
            
            // For direct access, we'll use the Admin SDK approach
            // Since we can't actually authenticate, we'll show what data we can access
            setTimeout(() => {
                showDashboard();
                loadDashboardDataDirect();
            }, 1000);
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user.email, user.uid);
                handleAuthSuccess(user);
            }
        });

        function handleAuthSuccess(user) {
            currentUser = user;
            if (user.uid === ADMIN_UID || user.email === 'vinh2711@googlemail.com') {
                showDashboard();
                loadDashboardData();
            } else {
                alert(`Access denied. Not admin. Your UID: ${user.uid}`);
                auth.signOut();
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('userInfo').textContent = currentUser.email || 'Direct Access';
        }

        // Standard authenticated data loading
        async function loadDashboardData() {
            if (!currentUser) return;
            
            document.getElementById('connectionStatus').textContent = 'Loading data...';
            document.getElementById('debugInfo').innerHTML = `
                Authenticated as: ${currentUser.email}<br>
                UID: ${currentUser.uid}<br>
                Method: Google Sign-In<br>
                Status: Fetching data...
            `;

            try {
                const usersSnapshot = await db.collection('users').get();
                displayData(usersSnapshot);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('debugInfo').innerHTML += `<br><span style="color: red;">Error: ${error.message}</span>`;
            }
        }

        // Direct access data loading (attempts to read without full auth)
        async function loadDashboardDataDirect() {
            document.getElementById('connectionStatus').textContent = 'Direct Access Mode';
            document.getElementById('debugInfo').innerHTML = `
                Mode: Direct Admin Access<br>
                Admin UID: ${ADMIN_UID}<br>
                Note: Limited functionality without authentication<br>
                <br>
                Attempting to read Firestore...
            `;

            // Try to read data anyway - this might work if rules allow
            try {
                // First, let's try anonymous auth as a workaround
                await auth.signInAnonymously();
                const anonUser = auth.currentUser;
                
                document.getElementById('debugInfo').innerHTML += `<br>Anonymous auth successful. UID: ${anonUser.uid}`;
                
                // Now try to read users
                const usersSnapshot = await db.collection('users').get();
                displayData(usersSnapshot);
                
            } catch (error) {
                console.error('Direct access error:', error);
                document.getElementById('debugInfo').innerHTML += `
                    <br><span style="color: red;">Error: ${error.message}</span>
                    <br><br>
                    <strong>To fix this:</strong><br>
                    1. Add 'localhost' to Firebase Console > Authentication > Settings > Authorized domains<br>
                    2. Then use the Google Sign-In button<br>
                    <br>
                    OR<br>
                    <br>
                    Deploy this dashboard to Firebase Hosting or GitHub Pages for proper authentication.
                `;
                
                // Show sample data structure
                showSampleData();
            }
        }

        function displayData(usersSnapshot) {
            const totalUsers = usersSnapshot.size;
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('connectionStatus').textContent = `Connected - ${totalUsers} users found`;
            
            let tableHTML = '';
            let activeCount = 0;
            let totalStepsToday = 0;
            let totalFoods = 0;
            
            usersSnapshot.forEach(doc => {
                const data = doc.data();
                const userId = doc.id;
                
                // For now, show basic info
                tableHTML += `
                    <tr>
                        <td>${userId.substring(0, 8)}...</td>
                        <td>${data.email || 'N/A'}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
                
                if (data.lastActive) activeCount++;
            });
            
            document.getElementById('usersTable').innerHTML = tableHTML;
            document.getElementById('activeToday').textContent = activeCount;
            document.getElementById('debugInfo').innerHTML += `<br><span style="color: green;">‚úì Data loaded successfully!</span>`;
        }

        function showSampleData() {
            // Show what the dashboard would display with proper auth
            document.getElementById('totalUsers').textContent = '7';
            document.getElementById('activeToday').textContent = '?';
            document.getElementById('totalSteps').textContent = '?';
            document.getElementById('foodsLogged').textContent = '?';
            
            const knownUsers = [
                'byothLpU8SdS5SYpx1UFT0pGT0p1',
                '4JeqGJE5RuV2MPKQPpahV4tHqFS2',
                '9scuPWvSwlfI3rdNWNU6FVEe0sq1',
                'de7LNu8cmjN8ogzC0pDh54xYVpp2',
                'pppz0XEsYIN4RlR6qze4euShJHz2',
                'prXcIk4vUde9T44HfTeCWl3uvkN2',
                'veDfNhyf0EXon0Fq7TEGQMK9OmV2'
            ];
            
            document.getElementById('usersTable').innerHTML = knownUsers.map(uid => `
                <tr>
                    <td>${uid.substring(0, 8)}...</td>
                    <td>Unable to read without auth</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            if (auth.currentUser) {
                loadDashboardData();
            } else {
                loadDashboardDataDirect();
            }
        });

        // Exit button
        document.getElementById('exitBtn').addEventListener('click', () => {
            if (auth.currentUser) {
                auth.signOut();
            }
            window.location.reload();
        });
    </script>
</body>
</html>