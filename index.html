<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROVI Admin Dashboard - Optimized</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Fixed chart heights - STRICT enforcement */
        .chart-container {
            position: relative;
            height: 300px !important;
            max-height: 300px !important;
            min-height: 300px !important;
            width: 100%;
            overflow: hidden !important;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 1rem 0;
            overflow: hidden !important;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .chart-description {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .data-scope {
            display: inline-block;
            background: #edf2f7;
            color: #2d3748;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .chart-card canvas {
            max-height: 300px !important;
            height: 300px !important;
            display: block !important;
        }
        
        /* Prevent chart.js from overriding styles */
        #stepsChart, #activityChart {
            max-height: 300px !important;
            height: 100% !important;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .leaderboard-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            margin: 0.5rem 0;
            transition: all 0.2s;
        }
        
        .leaderboard-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }
        
        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        
        .leaderboard-rank.gold { color: #ffd700; }
        .leaderboard-rank.silver { color: #c0c0c0; }
        .leaderboard-rank.bronze { color: #cd7f32; }
        
        .foods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .food-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s;
        }
        
        .food-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .food-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .food-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }
        
        .food-stats {
            font-size: 0.875rem;
            color: #718096;
        }
        
        .tab-buttons {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #718096;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-message {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .cache-info {
            font-size: 0.75rem;
            color: #718096;
            padding: 0.5rem;
            background: #f7fafc;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>üèÉ ROVI Admin Dashboard</h1>
            <p>Optimized Real-time Analytics</p>
            <button id="googleSignInBtn" class="btn-primary">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 20px; margin-right: 8px;">
                Sign in with Google
            </button>
            <div id="loginError" class="error-message" style="margin-top: 1rem; color: red;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard-container" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ROVI Analytics</h2>
                <span id="userEmail" style="font-size: 0.75rem; color: #718096;"></span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="overview">
                    <span class="icon">üìä</span> Overview
                </li>
                <li class="nav-item" data-page="leaderboards">
                    <span class="icon">üèÜ</span> Leaderboards
                </li>
                <li class="nav-item" data-page="foods">
                    <span class="icon">üçé</span> Food Database
                </li>
                <li class="nav-item" data-page="activities">
                    <span class="icon">üèÉ</span> Activities
                </li>
                <li class="nav-item" data-page="users">
                    <span class="icon">üë•</span> Users
                </li>
            </ul>
            <div class="sidebar-footer">
                <button id="refreshBtn" class="btn-refresh">üîÑ Refresh</button>
                <button id="signOutBtn" class="btn-logout">Sign Out</button>
                <div class="cache-info">
                    Cache: <span id="cacheStatus">Empty</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <h1 id="pageTitle">Dashboard Overview</h1>
                <span id="lastUpdate" style="font-size: 0.875rem; color: #718096;"></span>
            </header>

            <!-- Overview Page -->
            <div id="overviewPage" class="page-content">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3>Total Registered Users</h3>
                            <p class="stat-value" id="totalUsers">-</p>
                            <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="font-size: 0.75rem; color: #4a5568;">DATA SOURCE:</strong>
                                <span style="font-size: 0.75rem; color: #718096;">All users in database</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë£</div>
                        <div class="stat-content">
                            <h3>Total Steps Today</h3>
                            <p class="stat-value" id="totalStepsToday">-</p>
                            <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="font-size: 0.75rem; color: #4a5568;">DATA SOURCE:</strong>
                                <span style="font-size: 0.75rem; color: #718096;">Sum of ALL users' steps today</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üçé</div>
                        <div class="stat-content">
                            <h3>Food Database Items</h3>
                            <p class="stat-value" id="totalFoods">-</p>
                            <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="font-size: 0.75rem; color: #4a5568;">DATA SOURCE:</strong>
                                <span style="font-size: 0.75rem; color: #718096;">Actual count from foodDatabase</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-content">
                            <h3>Active Users Count</h3>
                            <p class="stat-value" id="activeToday">-</p>
                            <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="font-size: 0.75rem; color: #4a5568;">DATA SOURCE:</strong>
                                <span style="font-size: 0.75rem; color: #718096;">Users who logged steps > 0 today</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="insights-grid">
                    <div class="chart-card">
                        <div class="chart-title">
                            üìä Daily Steps Trend
                            <span class="data-scope">ALL USERS COMBINED</span>
                        </div>
                        <div class="chart-description">
                            <strong>What this shows:</strong> The total number of steps recorded by your entire community over the past week. Each point represents the sum of ALL users' steps for that day.
                        </div>
                        <div style="margin: 1rem 0; padding: 0.75rem; background: #fff5f5; border-radius: 8px;">
                            <label style="font-size: 0.875rem; color: #4a5568; cursor: pointer;">
                                <input type="checkbox" id="showTopUsersOnly" checked style="margin-right: 0.5rem;"> 
                                <strong>Filter:</strong> Show top 10 most active users only (uncheck to see ALL users)
                            </label>
                        </div>
                        <div class="chart-container">
                            <div style="position: absolute; width: 100%; height: 300px; overflow: hidden;">
                                <canvas id="stepsChart" style="position: absolute; width: 100% !important; height: 300px !important;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">
                            üèÉ Activity Distribution
                            <span class="data-scope">TODAY ONLY</span>
                        </div>
                        <div class="chart-description">
                            <strong>What this shows:</strong> A pie chart showing how many users have logged steps today (Active) versus how many haven't logged any activity yet (Inactive). Based on ALL registered users.
                        </div>
                        <div class="chart-container">
                            <div style="position: absolute; width: 100%; height: 300px; overflow: hidden;">
                                <canvas id="activityChart" style="position: absolute; width: 100% !important; height: 300px !important;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Leaderboard -->
                <div class="chart-card">
                    <div class="chart-title">
                        üèÜ Today's Top Performers
                        <span class="data-scope">INDIVIDUAL USERS</span>
                    </div>
                    <div class="chart-description">
                        <strong>What this shows:</strong> The top 5 individual users ranked by their step count today. Shows each user's email and their total steps.
                    </div>
                    <div id="quickLeaderboard">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                </div>
            </div>

            <!-- Leaderboards Page -->
            <div id="leaderboardsPage" class="page-content" style="display: none;">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="steps">üë£ Steps</button>
                    <button class="tab-button" data-tab="calories">üî• Calories</button>
                    <button class="tab-button" data-tab="activities">üèÉ Activities</button>
                    <button class="tab-button" data-tab="consistency">üìÖ Consistency</button>
                </div>

                <div id="leaderboardContent">
                    <div class="loading-message">
                        <div class="loading-spinner"></div>
                        <span>Loading leaderboards...</span>
                    </div>
                </div>
            </div>

            <!-- Foods Page -->
            <div id="foodsPage" class="page-content" style="display: none;">
                <div class="chart-card">
                    <h3>üçé Food Database Statistics</h3>
                    <div id="foodStats">
                        <p>Total Unique Foods: <strong id="uniqueFoodsCount">-</strong></p>
                        <p>Categories: <strong id="categoriesCount">-</strong></p>
                        <p>Most Popular Category: <strong id="topCategory">-</strong></p>
                    </div>
                </div>

                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="popular">üî• Most Popular</button>
                    <button class="tab-button" data-tab="recent">üïê Recently Added</button>
                    <button class="tab-button" data-tab="all">üìö All Foods</button>
                    <button class="tab-button" data-tab="search">üîç Search</button>
                </div>

                <div id="foodsContent">
                    <div class="loading-message">
                        <div class="loading-spinner"></div>
                        <span>Loading food database...</span>
                    </div>
                </div>
            </div>

            <!-- Activities Page -->
            <div id="activitiesPage" class="page-content" style="display: none;">
                <div class="chart-card">
                    <h3>üèÉ Recent Activities</h3>
                    <div id="activitiesContent">
                        <div class="loading-message">
                            <div class="loading-spinner"></div>
                            <span>Loading activities...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div id="usersPage" class="page-content" style="display: none;">
                <div class="chart-card">
                    <h3>üë• All Users</h3>
                    <div id="usersContent">
                        <div class="loading-message">
                            <div class="loading-spinner"></div>
                            <span>Loading users...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrNsSCG2FJ1es4BHe_URbwhuEpkA_5VyU",
            authDomain: "rovi-16b3a.firebaseapp.com",
            projectId: "rovi-16b3a",
            storageBucket: "rovi-16b3a.firebasestorage.app",
            databaseURL: "https://rovi-16b3a-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ADMIN_UID = 'byothLpU8SdS5SYpxlUFTOpGT0p1';
        
        // Cache management
        let dataCache = {
            users: null,
            foods: null,
            activities: {},
            calories: {},
            lastFetch: null
        };
        
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        
        let currentUser = null;
        let stepsChartInstance = null;
        let activityChartInstance = null;

        // Prevent chart expansion with MutationObserver
        function preventChartExpansion() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const target = mutation.target;
                        if (target.id === 'stepsChart' || target.id === 'activityChart') {
                            if (parseInt(target.style.height) > 300) {
                                target.style.height = '300px';
                                target.style.maxHeight = '300px';
                                target.height = 300;
                            }
                        }
                    }
                });
            });
            
            // Observe both chart canvases
            const stepsChart = document.getElementById('stepsChart');
            const activityChart = document.getElementById('activityChart');
            
            if (stepsChart) {
                observer.observe(stepsChart, { attributes: true, attributeFilter: ['style'] });
            }
            if (activityChart) {
                observer.observe(activityChart, { attributes: true, attributeFilter: ['style'] });
            }
        }
        
        // Start monitoring after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            preventChartExpansion();
            
            // Add event listener for the toggle
            const toggle = document.getElementById('showTopUsersOnly');
            if (toggle) {
                toggle.addEventListener('change', () => {
                    updateCharts();
                });
            }
        });
        
        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User signed in:', user.email);
                currentUser = user;
                
                if (user.uid === ADMIN_UID || user.email === 'vinh2711@googlemail.com') {
                    showDashboard(user);
                    await loadDashboardData();
                } else {
                    showError('Access denied. Admin only.');
                    auth.signOut();
                }
            } else {
                showLogin();
                currentUser = null;
            }
        });

        // Sign In
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await auth.signInWithPopup(provider);
            } catch (error) {
                showError(error.message);
            }
        });

        // Sign Out
        document.getElementById('signOutBtn').addEventListener('click', () => {
            dataCache = { users: null, foods: null, activities: {}, calories: {}, lastFetch: null };
            auth.signOut();
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                
                const page = this.dataset.page;
                document.querySelectorAll('.page-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                const pageElement = document.getElementById(page + 'Page');
                if (pageElement) {
                    pageElement.style.display = 'block';
                    document.getElementById('pageTitle').textContent = this.textContent.trim();
                    
                    // Load page-specific data
                    switch(page) {
                        case 'leaderboards':
                            loadLeaderboards();
                            break;
                        case 'foods':
                            loadFoodDatabase();
                            break;
                        case 'activities':
                            loadActivities();
                            break;
                        case 'users':
                            loadUsersPage();
                            break;
                    }
                }
            });
        });

        // Tab functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-button')) {
                const parent = e.target.parentElement;
                parent.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                const tab = e.target.dataset.tab;
                const page = document.querySelector('.page-content:not([style*="display: none"])').id;
                
                if (page === 'leaderboardsPage') {
                    loadLeaderboardTab(tab);
                } else if (page === 'foodsPage') {
                    loadFoodTab(tab);
                }
            }
        });

        // Refresh Button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            dataCache = { users: null, foods: null, activities: {}, calories: {}, lastFetch: null };
            loadDashboardData();
        });

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('userEmail').textContent = user.email;
        }

        function showError(message) {
            document.getElementById('loginError').textContent = message;
        }

        function updateCacheStatus() {
            const cacheSize = dataCache.users ? dataCache.users.length : 0;
            const cacheAge = dataCache.lastFetch ? 
                Math.round((Date.now() - dataCache.lastFetch) / 1000) : 0;
            
            document.getElementById('cacheStatus').textContent = 
                cacheSize > 0 ? `${cacheSize} users, ${cacheAge}s ago` : 'Empty';
        }

        // Main data loading function with caching
        async function loadDashboardData() {
            console.log('Loading dashboard data...');
            document.getElementById('lastUpdate').textContent = 'Updating...';
            
            // Check cache validity
            if (dataCache.lastFetch && (Date.now() - dataCache.lastFetch) < CACHE_DURATION) {
                console.log('Using cached data');
                updateUIFromCache();
                return;
            }
            
            try {
                // Load Users (cached)
                if (!dataCache.users) {
                    const usersSnapshot = await db.collection('users').get();
                    dataCache.users = usersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                document.getElementById('totalUsers').textContent = dataCache.users.length;
                
                // Load today's steps
                const today = new Date().toISOString().split('T')[0];
                let totalStepsToday = 0;
                let activeUsersToday = 0;
                
                // Batch load steps for all users
                const stepsPromises = dataCache.users.map(user => 
                    db.collection('users').doc(user.id)
                        .collection('stepsData').doc(today).get()
                        .then(doc => ({ userId: user.id, data: doc.exists ? doc.data() : null }))
                        .catch(err => ({ userId: user.id, data: null }))
                );
                
                const stepsResults = await Promise.all(stepsPromises);
                const dailySteps = {};
                
                stepsResults.forEach(result => {
                    if (result.data) {
                        const steps = result.data.steps || 0;
                        dailySteps[result.userId] = steps;
                        totalStepsToday += steps;
                        if (steps > 0) activeUsersToday++;
                    }
                });
                
                dataCache.todaySteps = dailySteps;
                document.getElementById('totalStepsToday').textContent = totalStepsToday.toLocaleString();
                document.getElementById('activeToday').textContent = activeUsersToday;
                
                // Load Food Database count (cached) - get ALL foods, not limited
                if (!dataCache.foods) {
                    // First get the actual count
                    const foodCountSnapshot = await db.collection('foodDatabase').get();
                    const actualFoodCount = foodCountSnapshot.size;
                    console.log(`Actual food database size: ${actualFoodCount} items`);
                    
                    // Load a reasonable subset for display (500 for performance)
                    const foodSnapshot = await db.collection('foodDatabase').limit(500).get();
                    dataCache.foods = foodSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    dataCache.totalFoodCount = actualFoodCount;
                }
                
                document.getElementById('totalFoods').textContent = dataCache.totalFoodCount || dataCache.foods.length;
                
                // Update cache timestamp
                dataCache.lastFetch = Date.now();
                updateCacheStatus();
                
                // Update charts
                await updateCharts();
                
                // Update quick leaderboard
                updateQuickLeaderboard();
                
                document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('lastUpdate').textContent = 'Error loading data';
            }
        }

        function updateUIFromCache() {
            document.getElementById('totalUsers').textContent = dataCache.users?.length || '-';
            document.getElementById('totalFoods').textContent = dataCache.foods?.length || '-';
            
            if (dataCache.todaySteps) {
                const totalSteps = Object.values(dataCache.todaySteps).reduce((a, b) => a + b, 0);
                const activeUsers = Object.values(dataCache.todaySteps).filter(s => s > 0).length;
                document.getElementById('totalStepsToday').textContent = totalSteps.toLocaleString();
                document.getElementById('activeToday').textContent = activeUsers;
            }
            
            updateQuickLeaderboard();
            document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date(dataCache.lastFetch).toLocaleTimeString() + ' (cached)';
        }

        async function updateCharts() {
            // Check if we should show all users or just top users
            const showTopOnly = document.getElementById('showTopUsersOnly')?.checked ?? true;
            const usersToShow = showTopOnly ? dataCache.users.slice(0, 10) : dataCache.users;
            
            console.log(`Showing steps for ${usersToShow.length} users (${showTopOnly ? 'top 10' : 'all'})`);
            
            // Get last 7 days of steps
            const last7Days = [];
            const stepsData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en', { weekday: 'short' });
                last7Days.push(dayName);
                
                let dayTotal = 0;
                
                // Use cached data if available for today
                if (i === 0 && dataCache.todaySteps) {
                    // Filter based on toggle
                    if (showTopOnly) {
                        const topUserIds = usersToShow.map(u => u.id);
                        dayTotal = Object.entries(dataCache.todaySteps)
                            .filter(([userId]) => topUserIds.includes(userId))
                            .reduce((sum, [, steps]) => sum + steps, 0);
                    } else {
                        dayTotal = Object.values(dataCache.todaySteps).reduce((a, b) => a + b, 0);
                    }
                } else {
                    // Batch load for historical data
                    const dayPromises = usersToShow.map(user => 
                        db.collection('users').doc(user.id)
                            .collection('stepsData').doc(dateStr).get()
                            .then(doc => doc.exists ? (doc.data().steps || 0) : 0)
                            .catch(() => 0)
                    );
                    
                    const dayResults = await Promise.all(dayPromises);
                    dayTotal = dayResults.reduce((a, b) => a + b, 0);
                }
                
                stepsData.push(dayTotal);
            }
            
            // Destroy existing chart if it exists
            if (stepsChartInstance) {
                stepsChartInstance.destroy();
                stepsChartInstance = null;
            }
            
            // Force canvas to exact size before creating chart
            const canvas = document.getElementById('stepsChart');
            const ctx = canvas.getContext('2d');
            
            // Clear any existing content
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Force exact dimensions
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.width = '100%';
            canvas.style.height = '300px';
            canvas.style.maxHeight = '300px';
            canvas.style.position = 'absolute';
            
            stepsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Total Steps',
                        data: stepsData,
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: false,  // DISABLE responsive to prevent growth
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0  // Disable animation to prevent flickering
                    },
                    layout: {
                        padding: 0
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    onResize: function(chart, size) {
                        // Prevent any resize beyond 300px
                        if (size.height > 300) {
                            chart.canvas.height = 300;
                            chart.canvas.style.height = '300px';
                            return false;
                        }
                    }
                }
            });
            
            // Activity distribution chart
            if (activityChartInstance) {
                activityChartInstance.destroy();
                activityChartInstance = null;
            }
            
            const activityCanvas = document.getElementById('activityChart');
            const activityCtx = activityCanvas.getContext('2d');
            
            // Clear and force dimensions
            activityCtx.clearRect(0, 0, activityCanvas.width, activityCanvas.height);
            activityCanvas.width = activityCanvas.offsetWidth;
            activityCanvas.height = 300;
            activityCanvas.style.width = '100%';
            activityCanvas.style.height = '300px';
            activityCanvas.style.maxHeight = '300px';
            activityCanvas.style.position = 'absolute';
            
            const activeUsers = Object.values(dataCache.todaySteps || {}).filter(s => s > 0).length;
            const inactiveUsers = dataCache.users.length - activeUsers;
            
            activityChartInstance = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active Today', 'Inactive Today'],
                    datasets: [{
                        data: [activeUsers, inactiveUsers],
                        backgroundColor: ['#48bb78', '#e2e8f0']
                    }]
                },
                options: {
                    responsive: false,  // DISABLE responsive
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    layout: {
                        padding: 0
                    },
                    onResize: function(chart, size) {
                        if (size.height > 300) {
                            chart.canvas.height = 300;
                            chart.canvas.style.height = '300px';
                            return false;
                        }
                    }
                }
            });
        }

        function updateQuickLeaderboard() {
            const sorted = Object.entries(dataCache.todaySteps || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            sorted.forEach(([userId, steps], index) => {
                const user = dataCache.users.find(u => u.id === userId);
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                html += `
                    <div class="leaderboard-item">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span class="leaderboard-rank ${rankClass}">${index + 1}</span>
                            <div>
                                <strong>${user?.email || userId.substring(0, 8) + '...'}</strong>
                                <div style="color: #718096; font-size: 0.875rem;">
                                    ${steps.toLocaleString()} steps today
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('quickLeaderboard').innerHTML = html || '<p>No activity data today</p>';
        }

        async function loadLeaderboards() {
            loadLeaderboardTab('steps');
        }

        async function loadLeaderboardTab(tab) {
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><span>Loading...</span></div>';
            
            let html = '';
            const today = new Date().toISOString().split('T')[0];
            
            switch(tab) {
                case 'steps':
                    const stepsLeaders = Object.entries(dataCache.todaySteps || {})
                        .sort((a, b) => b[1] - a[1]);
                    
                    html = '<h3>Today\'s Step Leaders</h3>';
                    stepsLeaders.forEach(([userId, steps], index) => {
                        const user = dataCache.users.find(u => u.id === userId);
                        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                        html += `
                            <div class="leaderboard-item">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="leaderboard-rank ${rankClass}">${index + 1}</span>
                                    <div style="flex: 1;">
                                        <strong>${user?.name || user?.email || userId.substring(0, 8) + '...'}</strong>
                                        <div style="color: #718096; font-size: 0.875rem;">
                                            ${steps.toLocaleString()} steps
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    break;
                    
                case 'calories':
                    html = '<h3>Calories Burned Leaders</h3>';
                    html += '<p style="color: #718096; font-size: 0.875rem;">Showing calories burned from activities logged today by ALL users</p>';
                    
                    // Load calories data from activityLog
                    if (!dataCache.calories[today]) {
                        const caloriesData = {};
                        
                        // Load calories for ALL users to ensure we catch everyone who logged
                        const caloriesPromises = dataCache.users.map(async user => {
                            try {
                                const entriesSnapshot = await db.collection('users').doc(user.id)
                                    .collection('activityLog').doc(today)
                                    .collection('entries').get();
                                
                                let totalCalories = 0;
                                entriesSnapshot.forEach(doc => {
                                    totalCalories += doc.data().caloriesBurned || 0;
                                });
                                
                                if (totalCalories > 0) {
                                    caloriesData[user.id] = totalCalories;
                                }
                            } catch (e) {
                                console.log(`Error loading calories for ${user.id}:`, e);
                            }
                        });
                        
                        await Promise.all(caloriesPromises);
                        dataCache.calories[today] = caloriesData;
                        console.log(`Loaded calorie data for ${Object.keys(caloriesData).length} users`);
                    }
                    
                    const caloriesLeaders = Object.entries(dataCache.calories[today] || {})
                        .sort((a, b) => b[1] - a[1]);
                    
                    caloriesLeaders.forEach(([userId, calories], index) => {
                        const user = dataCache.users.find(u => u.id === userId);
                        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                        html += `
                            <div class="leaderboard-item">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="leaderboard-rank ${rankClass}">${index + 1}</span>
                                    <div style="flex: 1;">
                                        <strong>${user?.name || user?.email || userId.substring(0, 8) + '...'}</strong>
                                        <div style="color: #718096; font-size: 0.875rem;">
                                            ${calories.toLocaleString()} calories burned
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (caloriesLeaders.length === 0) {
                        html += '<p>No calorie data available today</p>';
                    }
                    break;
                    
                case 'activities':
                    html = '<h3>Most Active Users</h3>';
                    
                    // Load activity counts
                    if (!dataCache.activities[today]) {
                        const activityData = {};
                        
                        const topUsers = dataCache.users.slice(0, 20);
                        const activityPromises = topUsers.map(async user => {
                            try {
                                const entriesSnapshot = await db.collection('users').doc(user.id)
                                    .collection('activityLog').doc(today)
                                    .collection('entries').get();
                                
                                if (entriesSnapshot.size > 0) {
                                    activityData[user.id] = entriesSnapshot.size;
                                }
                            } catch (e) {}
                        });
                        
                        await Promise.all(activityPromises);
                        dataCache.activities[today] = activityData;
                    }
                    
                    const activityLeaders = Object.entries(dataCache.activities[today] || {})
                        .sort((a, b) => b[1] - a[1]);
                    
                    activityLeaders.forEach(([userId, count], index) => {
                        const user = dataCache.users.find(u => u.id === userId);
                        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                        html += `
                            <div class="leaderboard-item">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="leaderboard-rank ${rankClass}">${index + 1}</span>
                                    <div style="flex: 1;">
                                        <strong>${user?.name || user?.email || userId.substring(0, 8) + '...'}</strong>
                                        <div style="color: #718096; font-size: 0.875rem;">
                                            ${count} activities logged
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (activityLeaders.length === 0) {
                        html += '<p>No activities logged today</p>';
                    }
                    break;
                    
                case 'consistency':
                    html = '<h3>Most Consistent Users (7 Days)</h3>';
                    
                    // Calculate consistency over last 7 days
                    const consistencyData = {};
                    
                    for (const user of dataCache.users.slice(0, 20)) {
                        let activeDays = 0;
                        
                        for (let i = 0; i < 7; i++) {
                            const date = new Date();
                            date.setDate(date.getDate() - i);
                            const dateStr = date.toISOString().split('T')[0];
                            
                            try {
                                const stepsDoc = await db.collection('users').doc(user.id)
                                    .collection('stepsData').doc(dateStr).get();
                                
                                if (stepsDoc.exists && stepsDoc.data().steps > 0) {
                                    activeDays++;
                                }
                            } catch (e) {}
                        }
                        
                        if (activeDays > 0) {
                            consistencyData[user.id] = activeDays;
                        }
                    }
                    
                    const consistencyLeaders = Object.entries(consistencyData)
                        .sort((a, b) => b[1] - a[1]);
                    
                    consistencyLeaders.forEach(([userId, days], index) => {
                        const user = dataCache.users.find(u => u.id === userId);
                        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                        html += `
                            <div class="leaderboard-item">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="leaderboard-rank ${rankClass}">${index + 1}</span>
                                    <div style="flex: 1;">
                                        <strong>${user?.name || user?.email || userId.substring(0, 8) + '...'}</strong>
                                        <div style="color: #718096; font-size: 0.875rem;">
                                            Active ${days}/7 days
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    break;
            }
            
            content.innerHTML = html;
        }

        async function loadFoodDatabase() {
            loadFoodTab('popular');
        }

        async function loadFoodTab(tab) {
            const content = document.getElementById('foodsContent');
            content.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><span>Loading...</span></div>';
            
            // Update stats with actual count
            document.getElementById('uniqueFoodsCount').textContent = dataCache.totalFoodCount || dataCache.foods?.length || '-';
            
            // Count categories
            const categories = {};
            dataCache.foods?.forEach(food => {
                const category = food.category || 'Uncategorized';
                categories[category] = (categories[category] || 0) + 1;
            });
            
            document.getElementById('categoriesCount').textContent = Object.keys(categories).length;
            
            const topCategory = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topCategory').textContent = topCategory ? `${topCategory[0]} (${topCategory[1]} items)` : 'N/A';
            
            let html = '';
            let foods = [];
            
            switch(tab) {
                case 'popular':
                    // Sort by popularity or usageCount
                    foods = (dataCache.foods || [])
                        .sort((a, b) => (b.usageCount || b.popularity || 0) - (a.usageCount || a.popularity || 0))
                        .slice(0, 20);
                    
                    html = '<h4>Top 20 Most Popular Foods</h4><div class="foods-grid">';
                    foods.forEach((food, index) => {
                        html += `
                            <div class="food-item">
                                <div class="food-emoji">${food.emoji || 'üçΩÔ∏è'}</div>
                                <div class="food-name">${food.name}</div>
                                <div class="food-stats">
                                    ${food.caloriesPerServing || 0} cal<br>
                                    Usage: ${food.usageCount || food.popularity || 0}
                                </div>
                                <div style="color: #4299e1; font-weight: bold;">#${index + 1}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;
                    
                case 'recent':
                    html = '<h4>Recently Added Foods</h4><div class="foods-grid">';
                    foods = (dataCache.foods || []).slice(-20).reverse();
                    foods.forEach(food => {
                        html += `
                            <div class="food-item">
                                <div class="food-emoji">${food.emoji || 'üçΩÔ∏è'}</div>
                                <div class="food-name">${food.name}</div>
                                <div class="food-stats">${food.caloriesPerServing || 0} cal</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;
                    
                case 'all':
                    html = `<h4>All Foods (${dataCache.foods?.length || 0} items)</h4>`;
                    html += '<div style="max-height: 600px; overflow-y: auto;">';
                    html += '<table class="data-table"><thead><tr><th>Name</th><th>Category</th><th>Calories</th><th>Usage</th></tr></thead><tbody>';
                    
                    (dataCache.foods || []).forEach(food => {
                        html += `
                            <tr>
                                <td>${food.emoji || ''} ${food.name}</td>
                                <td>${food.category || 'N/A'}</td>
                                <td>${food.caloriesPerServing || 0}</td>
                                <td>${food.usageCount || food.popularity || 0}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    break;
                    
                case 'search':
                    html = `
                        <div style="margin: 1rem 0;">
                            <input type="text" id="foodSearch" placeholder="Search foods..." style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        <div id="searchResults"></div>
                    `;
                    setTimeout(() => {
                        document.getElementById('foodSearch')?.addEventListener('input', (e) => {
                            const query = e.target.value.toLowerCase();
                            const filtered = (dataCache.foods || []).filter(f => 
                                f.name.toLowerCase().includes(query) ||
                                (f.searchTerms && f.searchTerms.some(term => term.toLowerCase().includes(query)))
                            );
                            
                            let resultsHtml = `<p>Found ${filtered.length} items</p><div class="foods-grid">`;
                            filtered.slice(0, 20).forEach(food => {
                                resultsHtml += `
                                    <div class="food-item">
                                        <div class="food-emoji">${food.emoji || 'üçΩÔ∏è'}</div>
                                        <div class="food-name">${food.name}</div>
                                        <div class="food-stats">${food.caloriesPerServing || 0} cal</div>
                                    </div>
                                `;
                            });
                            resultsHtml += '</div>';
                            document.getElementById('searchResults').innerHTML = resultsHtml;
                        });
                    }, 100);
                    break;
            }
            
            content.innerHTML = html;
        }

        async function loadActivities() {
            const content = document.getElementById('activitiesContent');
            content.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><span>Loading...</span></div>';
            
            const today = new Date().toISOString().split('T')[0];
            let allActivities = [];
            
            // Load activities for top 10 users to avoid too many reads
            const topUsers = dataCache.users.slice(0, 10);
            
            for (const user of topUsers) {
                try {
                    const entriesSnapshot = await db.collection('users').doc(user.id)
                        .collection('activityLog').doc(today)
                        .collection('entries').get();
                    
                    entriesSnapshot.forEach(doc => {
                        const data = doc.data();
                        allActivities.push({
                            user: user.email || user.id.substring(0, 8),
                            ...data
                        });
                    });
                } catch (e) {}
            }
            
            let html = `<h4>Today's Activities (${allActivities.length} total)</h4>`;
            if (allActivities.length === 0) {
                html += '<p>No activities logged today</p>';
            } else {
                html += '<div style="max-height: 600px; overflow-y: auto;">';
                allActivities.forEach(activity => {
                    html += `
                        <div class="leaderboard-item">
                            <div>
                                <strong>${activity.name || 'Activity'}</strong>
                                <div style="color: #718096; font-size: 0.875rem;">
                                    by ${activity.user} ‚Ä¢ ${activity.duration || 0} min ‚Ä¢ ${activity.caloriesBurned || 0} cal
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            content.innerHTML = html;
        }

        async function loadUsersPage() {
            const content = document.getElementById('usersContent');
            content.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><span>Loading...</span></div>';
            
            let html = '<div style="overflow-x: auto;"><table class="data-table">';
            html += '<thead><tr><th>User ID</th><th>Email</th><th>Name</th><th>Today\'s Steps</th><th>Created</th></tr></thead><tbody>';
            
            for (const user of dataCache.users || []) {
                const steps = dataCache.todaySteps?.[user.id] || 0;
                const created = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr>
                        <td>${user.id.substring(0, 12)}...</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.name || 'N/A'}</td>
                        <td>${steps.toLocaleString()}</td>
                        <td>${created}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table></div>';
            content.innerHTML = html;
        }
    </script>
</body>
</html>